<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>geohash</title>
    <script src="https://cdn.jsdelivr.net/npm/ol@v10.1.0/dist/ol.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v10.1.0/ol.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css">
    <style>
        .map {
            width: 1500px;
            height: 800px;
            margin: auto;
            margin-top: 25px;
        }
        .popover-body {
            min-width: 276px;
        }
    </style>
    <script>
        var current;
    </script>
  </head>
  <body>
    <div id="map" class="map"></div>
    <div id="popup" class="ol-popup"></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        var map = new ol.Map({
            layers: [new ol.layer.Tile({ source: new ol.source.OSM() })],
            view: new ol.View({
                zoom: 8,
                projection: 'EPSG:4326',
                center: new ol.geom.Point([136.9858554714588, 35.16251587222979])
                .getCoordinates()
            }),
            target: 'map'
        });

        var currentLocationFeature = new ol.Feature();
        var popupFeature = new ol.Feature();

        var vectorSource = new ol.source.Vector({
            features: [currentLocationFeature, popupFeature]
        });

        var vectorLayer = new ol.layer.Vector({
            source: vectorSource
        });
        map.addLayer(vectorLayer);

        let popupElement = document.getElementById('popup');

        var popup = new ol.Overlay({
            element: popupElement
        });
        map.addOverlay(popup);

        let popover;
        map.on('click', async (evt) => {
            const coordinate = evt.coordinate;
            popup.setPosition(coordinate);
            let popover = bootstrap.Popover.getInstance(popupElement);
            if (popover) {
                popover.dispose();
            }
            const response = await fetch(`/api/geohash/encode?lat=${coordinate[0]}&lng=${coordinate[1]}&zoom=${map.getView().getZoom()}`, {
                method: 'get'
            })
            const geohash = await response.json();

            popover = new bootstrap.Popover(popupElement, {
                animation: false,
                container: popupElement,
                content: `<p>The Geohash you clicked was:</p><code>${geohash.encode}</code>`,
                html: true,
                placement: 'top',
                title: 'GeoHash Here',
            });
            popover.show();
        });
    </script>
  </body>
</html>